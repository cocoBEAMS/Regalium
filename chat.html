<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #0b0f1a;
      color: white;
      font-family: Inter, sans-serif;
    }

    header {
      padding: 16px;
      border-bottom: 1px solid #1e2638;
      font-weight: 600;
    }

    #messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 14px;
    }

    .me {
      align-self: flex-end;
      background: #3b82f6;
    }

    .them {
      align-self: flex-start;
      background: #1e2638;
    }

    footer {
      display: flex;
      justify-content: center;
      padding: 12px;
      background: #121826;
      border-top: 1px solid #2c3349;
    }

    #footerContainer {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 800px;
      background: #1e2638;
      border-radius: 16px;
      padding: 8px;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
      align-items: center;
    }

    #footerContainer input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: #0f1420;
      color: white;
      font-size: 14px;
    }

    #footerContainer input[type="datetime-local"] {
      width: 160px;
      display: none;
    }

    #footerContainer button {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #footerContainer button:hover {
      background: #60a5fa;
      box-shadow: 0 0 10px #3b82f6;
    }

    /* Friend picker modal */
    #friendModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #friendBox {
      background: #0f1420;
      padding: 20px;
      border-radius: 14px;
      width: 320px;
    }

    #friendBox button {
      width: 100%;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<header id="chatHeader">Select a friend</header>
<div id="messages"></div>

<footer>
  <div id="footerContainer">
    <input id="chatInput" placeholder="Type a message..." />
    <input type="datetime-local" id="unlockInput" />
    <button id="timeCapsuleBtn">ðŸ•’</button>
    <button id="sendBtn">Send</button>
  </div>
</footer>

<!-- Friend Picker -->
<div id="friendModal">
  <div id="friendBox">
    <h3>Select a friend</h3>
    <div id="friendsList"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    getDocs,
    addDoc,
    query,
    where,
    orderBy,
    onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCvCAnjI58ns5dWgmcY_saq1w3W_Qe9I7Y",
    authDomain: "friendconnect-99a50.firebaseapp.com",
    projectId: "friendconnect-99a50",
    storageBucket: "friendconnect-99a50.appspot.com",
    messagingSenderId: "904196830848",
    appId: "1:904196830848:web:50c15121c2c04f1ea01865"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const headerEl = document.getElementById("chatHeader");
  const friendModal = document.getElementById("friendModal");
  const friendsList = document.getElementById("friendsList");
  const unlockInput = document.getElementById("unlockInput");
  const timeCapsuleBtn = document.getElementById("timeCapsuleBtn");

  let currentChatId = null;
  let currentUser = null;
  let capsuleMode = false;

  function getChatId(a, b) {
    return [a, b].sort().join("_");
  }

  async function loadFriends() {
    friendsList.innerHTML = "";
    const q = query(collection(db, "friends"), where("owner", "==", currentUser.uid));
    const snap = await getDocs(q);

    if (snap.empty) {
      friendsList.innerHTML = "<p>No friends yet!</p>";
      return;
    }

    snap.forEach(async (docSnap) => {
      const friendUid = docSnap.data().friend;
      const friendSnap = await getDoc(doc(db, "users", friendUid));
      if (!friendSnap.exists()) return;
      const friend = friendSnap.data();
      const btn = document.createElement("button");
      btn.textContent = friend.name;
      btn.onclick = () => openChat(friendUid, friend.name);
      friendsList.appendChild(btn);
    });
  }

  function openChat(friendUid, friendName) {
    currentChatId = getChatId(currentUser.uid, friendUid);
    headerEl.textContent = `Chat with ${friendName}`;
    friendModal.style.display = "none";
    listenForMessages();
  }

  function listenForMessages() {
    if (!currentChatId) return;
    const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("createdAt"));
    onSnapshot(q, (snap) => {
      messagesEl.innerHTML = "";
      snap.forEach((doc) => {
        const msg = doc.data();
        const now = new Date();
        const isUnlocked = !msg.unlockAt || msg.unlockAt.toDate() <= now;

        const div = document.createElement("div");
        div.className = `msg ${msg.sender === currentUser.uid ? "me" : "them"}`;
        div.textContent = isUnlocked ? msg.text : "â³ Time Capsule â€” unlocks later";

        if (msg.unlockAt && msg.unlockAt.toDate() > now) {
          div.style.fontStyle = "italic";
          div.style.opacity = 0.6;
        }

        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  async function sendMessage() {
    if (!currentUser || !currentChatId) return;
    const text = inputEl.value.trim();
    if (!text) return;

    const unlockAt = capsuleMode && unlockInput.value ? new Date(unlockInput.value) : null;

    await addDoc(collection(db, "chats", currentChatId, "messages"), {
      text,
      sender: currentUser.uid,
      createdAt: serverTimestamp(),
      unlockAt: unlockAt
    });

    inputEl.value = "";
    unlockInput.value = "";
    unlockInput.style.display = capsuleMode ? "inline-block" : "none";
    capsuleMode = false;
  }

  sendBtn.onclick = sendMessage;
  inputEl.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

  timeCapsuleBtn.onclick = () => {
    capsuleMode = !capsuleMode;
    unlockInput.style.display = capsuleMode ? "inline-block" : "none";
  };

  // âœ… Sign in anonymously and load friends
  signInAnonymously(auth).catch(console.error);

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    currentUser = user;
    await loadFriends();
  });
</script>

</body>
</html>
