<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #0b0f1a;
      color: white;
    }

    header {
      padding: 16px;
      font-weight: 600;
      border-bottom: 1px solid #1e2638;
    }

    #messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 14px;
      word-wrap: break-word;
    }

    .me { align-self: flex-end; background: #3b82f6; }
    .them { align-self: flex-start; background: #1e2638; }

    footer {
      padding: 12px;
      border-top: 1px solid #2c3349;
      background: #121826;
    }

    #footerContainer {
      display: flex;
      gap: 8px;
      max-width: 800px;
      margin: auto;
      background: #1e2638;
      padding: 8px;
      border-radius: 16px;
      align-items: center;
    }

    #footerContainer input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: #0f1420;
      color: white;
      font-size: 14px;
    }

    #footerContainer input[type="datetime-local"] {
      display: none;
    }

    #footerContainer button {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #footerContainer button:hover {
      background: #60a5fa;
      box-shadow: 0 0 10px #3b82f6;
    }

    /* Friend modal */
    #friendModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #friendBox {
      background: #0f1420;
      padding: 20px;
      border-radius: 14px;
      width: 320px;
      text-align: center;
    }

    #friendBox button {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }
  </style>
</head>
<body>

<header id="chatHeader">Select a friend</header>
<div id="messages"></div>

<footer>
  <div id="footerContainer">
    <input id="chatInput" placeholder="Type a message..." />
    <input type="datetime-local" id="unlockInput" />
    <button id="timeCapsuleBtn">ðŸ•’</button>
    <button id="sendBtn">Send</button>
  </div>
</footer>

<!-- Friend Picker -->
<div id="friendModal">
  <div id="friendBox">
    <h3>Select a friend</h3>
    <div id="friendsList"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, doc, getDoc, addDoc, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCvCAnjI58ns5dWgmcY_saq1w3W_Qe9I7Y",
    authDomain: "friendconnect-99a50.firebaseapp.com",
    projectId: "friendconnect-99a50",
    storageBucket: "friendconnect-99a50.appspot.com",
    messagingSenderId: "904196830848",
    appId: "1:904196830848:web:50c15121c2c04f1ea01865"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const headerEl = document.getElementById("chatHeader");
  const friendModal = document.getElementById("friendModal");
  const friendsList = document.getElementById("friendsList");
  const unlockInput = document.getElementById("unlockInput");
  const timeCapsuleBtn = document.getElementById("timeCapsuleBtn");

  let currentUser = null;
  let currentChatId = null;
  let capsuleMode = false;

  function getChatId(a, b) {
    return [a,b].sort().join("_");
  }

  async function loadFriends() {
    friendsList.innerHTML = "";
    const q = query(collection(db, "friends"), where("owner", "==", currentUser.uid));
    const snap = await getDocs(q);
    snap.forEach(async f => {
      const friendSnap = await getDoc(doc(db, "users", f.data().friend));
      if (!friendSnap.exists()) return;
      const friend = friendSnap.data();
      const btn = document.createElement("button");
      btn.textContent = friend.name;
      btn.onclick = () => openChat(f.data().friend, friend.name);
      friendsList.appendChild(btn);
    });
  }

  function openChat(friendUid, friendName) {
    currentChatId = getChatId(currentUser.uid, friendUid);
    headerEl.textContent = `Chat with ${friendName}`;
    friendModal.style.display = "none";
    listenForMessages();
  }

  function listenForMessages() {
    const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("createdAt"));
    onSnapshot(q, snap => {
      messagesEl.innerHTML = "";
      snap.forEach(docSnap => {
        const msg = docSnap.data();
        const now = new Date();
        const unlockAt = msg.unlockAt ? msg.unlockAt.toDate() : null;
        const isUnlocked = !unlockAt || unlockAt <= now;

        const div = document.createElement("div");
        div.className = `msg ${msg.sender === currentUser.uid ? "me" : "them"}`;
        div.textContent = isUnlocked ? msg.text : "â³ Time Capsule â€” unlocks later";
        if (!isUnlocked) {
          div.style.fontStyle = "italic";
          div.style.opacity = 0.6;
        }
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  async function sendMessage() {
    if (!currentUser || !currentChatId) return;
    const text = inputEl.value.trim();
    if (!text) return;

    const unlockAt = capsuleMode && unlockInput.value ? new Date(unlockInput.value) : null;
    await addDoc(collection(db, "chats", currentChatId, "messages"), {
      text,
      sender: currentUser.uid,
      createdAt: serverTimestamp(),
      unlockAt: unlockAt
    });

    inputEl.value = "";
    unlockInput.value = "";
    unlockInput.style.display = capsuleMode ? "inline-block" : "none";
    capsuleMode = false;
  }

  sendBtn.onclick = sendMessage;
  inputEl.addEventListener("keydown", e => { if(e.key === "Enter") sendMessage(); });
  timeCapsuleBtn.onclick = () => {
    capsuleMode = !capsuleMode;
    unlockInput.style.display = capsuleMode ? "inline-block" : "none";
  };

  onAuthStateChanged(auth, async user => {
    if (!user) return;
    currentUser = user;
    await loadFriends();
  });
</script>
</body>
</html>
